<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mylitta — Учёт заказов</title>

<style>
:root {
--brand: #ff6fb1;
--brand-dark: #e85fa0;
--bg: #fff7fc;
--card: #ffffff;
--border: #ffd3ea;
--text: #333;
--success: #c8f7c5;
--shadow: 0 4px 14px rgba(255, 111, 177, 0.15);
}

body {
margin: 0;
padding: 0;
background: var(--bg);
font-family: "Segoe UI", sans-serif;
color: var(--text);
}

.header {
background: var(--brand);
padding: 22px 24px;
color: white;
font-size: 32px;
font-weight: 700;
text-align: center;
}

.container { margin: 20px; }

.toolbar {
background: var(--card);
padding: 12px;
border-radius: 12px;
box-shadow: var(--shadow);
border: 1px solid var(--border);
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-bottom: 18px;
}

input, select, textarea {
padding: 8px 10px;
border-radius: 8px;
border: 1px solid var(--border);
font-size: 14px;
}

/* Поле "Товары" — независимое, растягивается только вниз */
textarea.cell-items {
min-height: 40px;
width: 100%;
resize: vertical;
overflow: auto;
display: block;
}

/* Фикс ширины колонки "Сумма" */
td:nth-child(6), th:nth-child(6) {
width: 80px;
max-width: 80px;
min-width: 80px;
white-space: nowrap;
}

/* Горизонтальный скролл таблицы */
.table-wrapper {
background: var(--card);
border-radius: 12px;
box-shadow: var(--shadow);
border: 1px solid var(--border);
overflow-x: auto;
overflow-y: hidden;
}

table {
width: 100%;
min-width: 900px; /* чтобы таблица не сжималась */
border-collapse: collapse;
}

th {
background: #ffe3f2;
padding: 8px;
font-weight: 600;
border-bottom: 2px solid var(--border);
text-align: center;
}

td {
padding: 6px;
border-bottom: 1px solid var(--border);
text-align: center;
}

.paid-row { background: var(--success) !important; }
</style>
</head>

<body>

<div class="header">Mylitta — Учёт заказов</div>

<div class="container">

<div class="toolbar">
<input id="searchInput" placeholder="Поиск..." oninput="applyFilters()">
<select id="filterPayment" onchange="applyFilters()">
<option value="all">Все оплаты</option>
<option value="paid">Оплачено</option>
<option value="unpaid">Не оплачено</option>
</select>
<select id="filterSent" onchange="applyFilters()">
<option value="all">Все отправки</option>
<option value="sent">Отправлено</option>
<option value="not_sent">Не отправлено</option>
</select>
<button onclick="addRow()">Добавить строку</button>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>№</th>
<th>Имя</th>
<th>Телефон</th>
<th>Адрес</th>
<th>Товары</th>
<th>Сумма</th>
<th>Оплата</th>
<th>Сервис</th>
<th>Отправка</th>
<th>Сброс</th>
<th>Полный сброс</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyAq7NnxP_58TGTdDyyZ3eTcWfECoyGvxC0",
authDomain: "mylitta-orders.firebaseapp.com",
projectId: "mylitta-orders",
storageBucket: "mylitta-orders.firebasestorage.app",
messagingSenderId: "882881706964",
appId: "1:882881706964:web:65b58522679ad561d17441"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let counter = 1;
let isUpdatingFromFirebase = false;

/* ДЕБАУНС — чтобы ввод и удаление не лагали */
let saveTimeout = null;
function saveDataDebounced() {
clearTimeout(saveTimeout);
saveTimeout = setTimeout(saveDataToFirebase, 250);
}

/* Глобальные функции */
window.addRow = addRow;
window.applyFilters = applyFilters;
window.resetPurchases = resetPurchases;
window.resetFullRow = resetFullRow;
window.updateRowAppearance = updateRowAppearance;

/* Сохранение */
function saveDataToFirebase() {
if (isUpdatingFromFirebase) return;

const rows = [];
document.querySelectorAll("#tableBody tr").forEach(row => {
const cells = row.querySelectorAll("input, textarea, select");
const rowData = [];
cells.forEach(c => rowData.push(c.value));
rows.push(rowData);
});

set(ref(db, "orders"), rows);
}

/* Загрузка */
function loadDataFromFirebase(rows) {
isUpdatingFromFirebase = true;

const table = document.getElementById("tableBody");
table.innerHTML = "";
counter = 1;

rows.forEach(r => addRow(r));

isUpdatingFromFirebase = false;
}

/* Добавление строки */
function addRow(savedData = null) {
const table = document.getElementById("tableBody");
const row = document.createElement("tr");

row.innerHTML = `
<td>${counter}</td>
<td><input class="cell-name"></td>
<td><input></td>
<td><input></td>
<td><textarea class="cell-items"></textarea></td>
<td><input class="cell-sum" readonly></td>

<td>
<select class="cell-payment" onchange="updateRowAppearance(this); saveDataDebounced(); applyFilters();">
<option value="no">Не оплачено</option>
<option value="yes">Оплачено</option>
</select>
</td>

<td>
<select onchange="saveDataDebounced()">
<option>Белпочта</option>
<option>ЕвроПочта</option>
</select>
</td>

<td>
<select class="cell-sent" onchange="saveDataDebounced(); applyFilters()">
<option value="no">Не отправлено</option>
<option value="yes">Отправлено</option>
</select>
</td>

<td><button onclick="resetPurchases(this)">Сбросить</button></td>
<td><button onclick="resetFullRow(this)">Полный сброс</button></td>
`;

table.appendChild(row);

const items = row.querySelector(".cell-items");
const sum = row.querySelector(".cell-sum");

items.addEventListener("input", () => {
let total = 0;
items.value.split("\n").forEach(line => {
const parts = line.trim().split(" ");
const last = parseFloat(parts.at(-1));
if (!isNaN(last)) total += last;
});
sum.value = total;
saveDataDebounced();
});

row.querySelectorAll("input, textarea").forEach(el => {
el.addEventListener("input", saveDataDebounced);
});

if (savedData) {
const inputs = row.querySelectorAll("input, textarea, select");
savedData.forEach((v, i) => inputs[i].value = v);
updateRowAppearance(row.querySelector(".cell-payment"));
}

counter++;
saveDataDebounced();
}

function updateRowAppearance(select) {
const row = select.closest("tr");
if (select.value === "yes") row.classList.add("paid-row");
else row.classList.remove("paid-row");
}

function resetPurchases(btn) {
const row = btn.closest("tr");
row.querySelector(".cell-items").value = "";
row.querySelector(".cell-sum").value = 0;
saveDataDebounced();
}

function resetFullRow(btn) {
const row = btn.closest("tr");
row.querySelectorAll("input, textarea").forEach(el => el.value = "");
row.querySelector(".cell-payment").value = "no";
row.querySelector(".cell-sent").value = "no";
row.classList.remove("paid-row");
saveDataDebounced();
applyFilters();
}

function applyFilters() {
const search = document.getElementById("searchInput").value.toLowerCase();
const pay = document.getElementById("filterPayment").value;
const sent = document.getElementById("filterSent").value;

document.querySelectorAll("#tableBody tr").forEach(row => {
let visible = true;

const name = row.querySelector(".cell-name").value.toLowerCase();
const payment = row.querySelector(".cell-payment").value;
const sentVal = row.querySelector(".cell-sent").value;

if (search && !name.includes(search)) visible = false;
if (pay === "paid" && payment !== "yes") visible = false;
if (pay === "unpaid" && payment !== "no") visible = false;
if (sent === "sent" && sentVal !== "yes") visible = false;
if (sent === "not_sent" && sentVal !== "no") visible = false;

row.style.display = visible ? "" : "none";
});
}

/* Автообновление */
onValue(ref(db, "orders"), snap => {
const rows = snap.val();
if (rows) loadDataFromFirebase(rows);
});
</script>

</body>
</html>
