<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mylitta — Учёт заказов</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
--brand: #ff6fb1;
--brand-dark: #e85fa0;
--bg: #fff7fc;
--card: #ffffff;
--border: #ffd3ea;
--text: #333;
--success: #c8f7c5;
--shadow: 0 4px 14px rgba(255, 111, 177, 0.15);
}

* {
box-sizing: border-box;
}

body {
margin: 0;
padding: 0;
background: var(--bg);
font-family: "Segoe UI", sans-serif;
color: var(--text);
}

.header {
background: var(--brand);
padding: 22px 24px;
color: white;
font-size: 32px;
font-weight: 700;
text-align: center;
}

.container { 
margin: 20px;
overflow-x: auto; /* Добавлено для мобильных */
}

.toolbar {
background: var(--card);
padding: 12px;
border-radius: 12px;
box-shadow: var(--shadow);
border: 1px solid var(--border);
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-bottom: 18px;
}

/* ФИКС: Улучшение интерактивности полей ввода */
input, select, textarea {
padding: 8px 10px;
border-radius: 8px;
border: 1px solid var(--border);
font-size: 14px;
font-family: "Segoe UI", sans-serif;
background: white;
transition: border 0.2s, box-shadow 0.2s;
width: 100%; /* Важно для ячеек таблицы */
}

input:focus, select:focus, textarea:focus {
outline: none;
border-color: var(--brand);
box-shadow: 0 0 0 2px rgba(255, 111, 177, 0.2);
}

/* Особые стили для textarea "Товары" */
textarea.cell-items {
min-height: 40px;
height: 40px; /* Начальная высота */
resize: vertical;
overflow-y: auto;
display: block;
line-height: 1.4;
}

/* ФИКС: Оптимизация ширины колонок */
.table-wrapper {
background: var(--card);
border-radius: 12px;
box-shadow: var(--shadow);
border: 1px solid var(--border);
overflow-x: auto;
overflow-y: hidden;
margin-top: 10px;
}

table {
width: 100%;
min-width: 1200px; /* Увеличил минимальную ширину */
border-collapse: collapse;
table-layout: fixed; /* Важно для фиксированных колонок */
}

/* Фиксированные ширины для колонок */
th, td {
padding: 6px 4px; /* Уменьшил горизонтальные отступы */
vertical-align: top;
border-bottom: 1px solid var(--border);
word-wrap: break-word;
}

/* Ширины колонок */
th:nth-child(1), td:nth-child(1) { width: 40px; } /* № */
th:nth-child(2), td:nth-child(2) { width: 120px; } /* Имя */
th:nth-child(3), td:nth-child(3) { width: 120px; } /* Телефон */
th:nth-child(4), td:nth-child(4) { width: 150px; } /* Адрес */
th:nth-child(5), td:nth-child(5) { width: 250px; } /* Товары */
th:nth-child(6), td:nth-child(6) { width: 80px; } /* Сумма */
th:nth-child(7), td:nth-child(7) { width: 100px; } /* Оплата */
th:nth-child(8), td:nth-child(8) { width: 100px; } /* Сервис */
th:nth-child(9), td:nth-child(9) { width: 100px; } /* Отправка */
th:nth-child(10), td:nth-child(10) { width: 80px; } /* Сброс */
th:nth-child(11), td:nth-child(11) { width: 100px; } /* Полный сброс */

th {
background: #ffe3f2;
padding: 8px 4px;
font-weight: 600;
border-bottom: 2px solid var(--border);
text-align: center;
position: sticky;
top: 0;
z-index: 10;
}

td {
text-align: center;
}

/* Центрирование контента в ячейках */
td > input,
td > textarea,
td > select {
margin: 0 auto;
display: block;
text-align: center;
}

/* Особый стиль для textarea - выравнивание по левому краю */
textarea.cell-items {
text-align: left;
padding: 6px;
}

/* Особый стиль для поля "Сумма" */
input.cell-sum {
font-weight: bold;
color: #e85fa0;
background: #fff0f7;
text-align: center;
}

/* Кнопки в ячейках */
td button {
padding: 6px 10px;
background: var(--brand);
color: white;
border: none;
border-radius: 6px;
cursor: pointer;
font-size: 13px;
transition: background 0.2s;
width: 100%;
}

td button:hover {
background: var(--brand-dark);
}

.paid-row { 
background: var(--success) !important; 
}

/* Стили для селектов оплаты/отправки */
select.cell-payment, select.cell-sent {
min-width: 90px;
}

/* Стиль для фильтров */
#searchInput {
min-width: 200px;
flex-grow: 1;
}

.toolbar button {
padding: 8px 16px;
background: var(--brand);
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: background 0.2s;
}

.toolbar button:hover {
background: var(--brand-dark);
}

/* Улучшение скролла */
.table-wrapper::-webkit-scrollbar {
height: 8px;
}

.table-wrapper::-webkit-scrollbar-track {
background: #ffe3f2;
border-radius: 4px;
}

.table-wrapper::-webkit-scrollbar-thumb {
background: var(--brand);
border-radius: 4px;
}
</style>
</head>

<body>

<div class="header">Mylitta — Учёт заказов</div>

<div class="container">

<div class="toolbar">
<input id="searchInput" placeholder="Поиск по имени..." oninput="applyFilters()">
<select id="filterPayment" onchange="applyFilters()">
<option value="all">Все оплаты</option>
<option value="paid">Оплачено</option>
<option value="unpaid">Не оплачено</option>
</select>
<select id="filterSent" onchange="applyFilters()">
<option value="all">Все отправки</option>
<option value="sent">Отправлено</option>
<option value="not_sent">Не отправлено</option>
</select>
<button onclick="addRow()">➕ Добавить строку</button>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>№</th>
<th>Имя</th>
<th>Телефон</th>
<th>Адрес</th>
<th>Товары</th>
<th>Сумма</th>
<th>Оплата</th>
<th>Сервис</th>
<th>Отправка</th>
<th>Сброс</th>
<th>Полный сброс</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyAq7NnxP_58TGTdDyyZ3eTcWfECoyGvxC0",
authDomain: "mylitta-orders.firebaseapp.com",
projectId: "mylitta-orders",
storageBucket: "mylitta-orders.firebasestorage.app",
messagingSenderId: "882881706964",
appId: "1:882881706964:web:65b58522679ad561d17441"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let counter = 1;
let isUpdatingFromFirebase = false;

/* ДЕБАУНС — чтобы ввод и удаление не лагали */
let saveTimeout = null;
function saveDataDebounced() {
clearTimeout(saveTimeout);
saveTimeout = setTimeout(saveDataToFirebase, 250);
}

/* Глобальные функции */
window.addRow = addRow;
window.applyFilters = applyFilters;
window.resetPurchases = resetPurchases;
window.resetFullRow = resetFullRow;
window.updateRowAppearance = updateRowAppearance;

/* Сохранение */
function saveDataToFirebase() {
if (isUpdatingFromFirebase) return;

const rows = [];
document.querySelectorAll("#tableBody tr").forEach(row => {
const cells = row.querySelectorAll("input, textarea, select");
const rowData = [];
cells.forEach(c => rowData.push(c.value));
rows.push(rowData);
});

set(ref(db, "orders"), rows);
}

/* Загрузка */
function loadDataFromFirebase(rows) {
isUpdatingFromFirebase = true;

const table = document.getElementById("tableBody");
table.innerHTML = "";
counter = 1;

rows.forEach(r => addRow(r));

isUpdatingFromFirebase = false;
}

/* Добавление строки */
function addRow(savedData = null) {
const table = document.getElementById("tableBody");
const row = document.createElement("tr");

row.innerHTML = `
<td>${counter}</td>
<td><input class="cell-name" placeholder="Имя клиента"></td>
<td><input placeholder="+375..."></td>
<td><input placeholder="Адрес"></td>
<td><textarea class="cell-items" placeholder="Товар 1 100\nТовар 2 50"></textarea></td>
<td><input class="cell-sum" readonly value="0"></td>

<td>
<select class="cell-payment" onchange="updateRowAppearance(this); saveDataDebounced(); applyFilters();">
<option value="no">Не оплачено</option>
<option value="yes">Оплачено</option>
</select>
</td>

<td>
<select onchange="saveDataDebounced()">
<option>Белпочта</option>
<option>ЕвроПочта</option>
<option>Самовывоз</option>
</select>
</td>

<td>
<select class="cell-sent" onchange="saveDataDebounced(); applyFilters()">
<option value="no">Не отправлено</option>
<option value="yes">Отправлено</option>
</select>
</td>

<td><button onclick="resetPurchases(this)">Сбросить</button></td>
<td><button onclick="resetFullRow(this)">Полный сброс</button></td>
`;

table.appendChild(row);

const items = row.querySelector(".cell-items");
const sum = row.querySelector(".cell-sum");

// ФИКС: Улучшенный расчет суммы
items.addEventListener("input", () => {
let total = 0;
const lines = items.value.split("\n");
lines.forEach(line => {
const trimmed = line.trim();
if (trimmed) {
const parts = trimmed.split(" ");
const last = parseFloat(parts[parts.length - 1]);
if (!isNaN(last)) {
total += last;
}
}
});
sum.value = total.toFixed(2);
saveDataDebounced();
});

// ФИКС: Автофокус при добавлении новой строки
if (!savedData) {
setTimeout(() => {
row.querySelector(".cell-name").focus();
}, 10);
}

// Обработчики для всех полей ввода
row.querySelectorAll("input, textarea, select").forEach(el => {
el.addEventListener("input", saveDataDebounced);
el.addEventListener("change", saveDataDebounced);
});

// Заполнение сохраненными данными
if (savedData) {
const inputs = row.querySelectorAll("input, textarea, select");
savedData.forEach((v, i) => {
if (inputs[i]) inputs[i].value = v;
});
updateRowAppearance(row.querySelector(".cell-payment"));
}

counter++;
saveDataDebounced();
}

function updateRowAppearance(select) {
const row = select.closest("tr");
if (select.value === "yes") {
row.classList.add("paid-row");
} else {
row.classList.remove("paid-row");
}
}

function resetPurchases(btn) {
const row = btn.closest("tr");
row.querySelector(".cell-items").value = "";
row.querySelector(".cell-sum").value = "0";
saveDataDebounced();
}

function resetFullRow(btn) {
const row = btn.closest("tr");
row.querySelectorAll("input, textarea").forEach(el => {
if (el.classList.contains("cell-sum")) {
el.value = "0";
} else {
el.value = "";
}
});
row.querySelector(".cell-payment").value = "no";
row.querySelector(".cell-sent").value = "no";
row.classList.remove("paid-row");
saveDataDebounced();
applyFilters();
}

function applyFilters() {
const search = document.getElementById("searchInput").value.toLowerCase();
const pay = document.getElementById("filterPayment").value;
const sent = document.getElementById("filterSent").value;

document.querySelectorAll("#tableBody tr").forEach(row => {
let visible = true;

const nameInput = row.querySelector(".cell-name");
const paymentSelect = row.querySelector(".cell-payment");
const sentSelect = row.querySelector(".cell-sent");

if (!nameInput || !paymentSelect || !sentSelect) return;

const name = nameInput.value.toLowerCase();
const payment = paymentSelect.value;
const sentVal = sentSelect.value;

if (search && !name.includes(search)) visible = false;
if (pay === "paid" && payment !== "yes") visible = false;
if (pay === "unpaid" && payment !== "no") visible = false;
if (sent === "sent" && sentVal !== "yes") visible = false;
if (sent === "not_sent" && sentVal !== "no") visible = false;

row.style.display = visible ? "" : "none";
});
}

/* Автообновление */
onValue(ref(db, "orders"), snap => {
const rows = snap.val();
if (rows) loadDataFromFirebase(rows);
});

// Инициализация первой строки при загрузке
document.addEventListener('DOMContentLoaded', () => {
setTimeout(() => {
if (document.querySelectorAll("#tableBody tr").length === 0) {
addRow();
}
}, 100);
});
</script>

</body>
</html>
