<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mylitta — Учёт заказов</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
--brand: #ff6fb1;
--brand-dark: #e85fa0;
--bg: #fff7fc;
--card: #ffffff;
--border: #ffd3ea;
--text: #333;
--success: #c8f7c5;
--shadow: 0 4px 14px rgba(255, 111, 177, 0.15);
}

* {
box-sizing: border-box;
}

body {
margin: 0;
padding: 0;
background: var(--bg);
font-family: "Segoe UI", sans-serif;
color: var(--text);
}

.header {
background: var(--brand);
padding: 22px 24px;
color: white;
font-size: 32px;
font-weight: 700;
text-align: center;
}

.container { 
margin: 20px;
overflow-x: auto;
}

.toolbar {
background: var(--card);
padding: 12px;
border-radius: 12px;
box-shadow: var(--shadow);
border: 1px solid var(--border);
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-bottom: 18px;
}

/* Стили для полей ввода */
input, select, textarea {
padding: 10px 12px;
border-radius: 8px;
border: 1px solid var(--border);
font-size: 15px;
font-family: "Segoe UI", sans-serif;
background: white;
transition: all 0.3s;
width: 100%;
}

input:focus, select:focus, textarea:focus {
outline: none;
border-color: var(--brand);
box-shadow: 0 0 0 3px rgba(255, 111, 177, 0.3);
background-color: #fff9fc;
}

/* Особые стили для textarea "Товары" */
textarea.cell-items {
min-height: 45px;
height: 45px;
resize: vertical;
overflow-y: auto;
display: block;
line-height: 1.5;
padding: 8px 10px;
font-size: 14px;
}

/* Индикатор несохраненных изменений */
input.changed, textarea.changed, select.changed {
background-color: #fff9e6 !important;
border-color: #ffcc00 !important;
}

/* Сообщение о сохранении */
.save-notification {
position: fixed;
top: 20px;
right: 20px;
background: #4CAF50;
color: white;
padding: 12px 20px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
z-index: 1000;
opacity: 0;
transform: translateY(-10px);
transition: opacity 0.3s, transform 0.3s;
pointer-events: none;
}

.save-notification.show {
opacity: 1;
transform: translateY(0);
}

.save-notification.saving {
background: #2196F3;
}

/* ФИКС: Оптимизация ширины колонок */
.table-wrapper {
background: var(--card);
border-radius: 12px;
box-shadow: var(--shadow);
border: 1px solid var(--border);
overflow-x: auto;
overflow-y: hidden;
margin-top: 10px;
}

table {
width: 100%;
min-width: 1250px;
border-collapse: collapse;
table-layout: fixed;
}

/* Фиксированные ширины для колонок */
th, td {
padding: 8px 6px;
vertical-align: middle;
border-bottom: 1px solid var(--border);
word-wrap: break-word;
}

/* Ширины колонок */
th:nth-child(1), td:nth-child(1) { width: 50px; } /* № */
th:nth-child(2), td:nth-child(2) { width: 140px; } /* Имя */
th:nth-child(3), td:nth-child(3) { width: 140px; } /* Телефон */
th:nth-child(4), td:nth-child(4) { width: 180px; } /* Адрес */
th:nth-child(5), td:nth-child(5) { width: 280px; min-width: 280px; } /* Товары */
th:nth-child(6), td:nth-child(6) { width: 90px; } /* Сумма */
th:nth-child(7), td:nth-child(7) { width: 110px; } /* Оплата */
th:nth-child(8), td:nth-child(8) { width: 120px; } /* Сервис */
th:nth-child(9), td:nth-child(9) { width: 120px; } /* Отправка */
th:nth-child(10), td:nth-child(10) { width: 100px; } /* Сброс */
th:nth-child(11), td:nth-child(11) { width: 120px; } /* Полный сброс */

th {
background: #ffe3f2;
padding: 12px 6px;
font-weight: 600;
border-bottom: 2px solid var(--border);
text-align: center;
position: sticky;
top: 0;
z-index: 10;
}

td {
text-align: center;
}

/* Центрирование контента в ячейках */
td > input,
td > textarea,
td > select {
margin: 0 auto;
display: block;
}

/* Особый стиль для textarea */
textarea.cell-items {
text-align: left;
resize: vertical;
min-height: 60px;
height: 60px;
}

/* Особый стиль для поля "Сумма" */
input.cell-sum {
font-weight: bold;
color: #e85fa0;
background: #fff0f7;
text-align: center;
font-size: 16px;
}

/* Кнопки в ячейках */
td button {
padding: 8px 12px;
background: var(--brand);
color: white;
border: none;
border-radius: 6px;
cursor: pointer;
font-size: 14px;
transition: background 0.2s;
width: 100%;
font-weight: 500;
}

td button:hover {
background: var(--brand-dark);
}

.paid-row { 
background: var(--success) !important; 
}

/* Стиль для селектов оплаты/отправки */
select.cell-payment, select.cell-sent {
min-width: 100px;
font-size: 14px;
}

/* Стиль для фильтров */
#searchInput {
min-width: 220px;
flex-grow: 1;
font-size: 15px;
}

.toolbar button {
padding: 10px 20px;
background: var(--brand);
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
font-size: 15px;
transition: background 0.2s;
}

.toolbar button:hover {
background: var(--brand-dark);
}

/* Улучшение скролла */
.table-wrapper::-webkit-scrollbar {
height: 10px;
}

.table-wrapper::-webkit-scrollbar-track {
background: #ffe3f2;
border-radius: 5px;
}

.table-wrapper::-webkit-scrollbar-thumb {
background: var(--brand);
border-radius: 5px;
}

/* Статус бар */
.status-bar {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: #f5f5f5;
padding: 8px 20px;
font-size: 13px;
color: #666;
border-top: 1px solid #ddd;
display: flex;
justify-content: space-between;
z-index: 100;
}

.status-item {
display: flex;
align-items: center;
gap: 5px;
}

.status-dot {
width: 8px;
height: 8px;
border-radius: 50%;
background: #4CAF50;
}

.status-dot.offline {
background: #ff9800;
}
</style>
</head>

<body>

<div class="header">Mylitta — Учёт заказов</div>
<div class="save-notification" id="saveNotification">Сохранено ✓</div>

<div class="container">

<div class="toolbar">
<input id="searchInput" placeholder="Поиск по имени..." oninput="applyFilters()">
<select id="filterPayment" onchange="applyFilters()">
<option value="all">Все оплаты</option>
<option value="paid">Оплачено</option>
<option value="unpaid">Не оплачено</option>
</select>
<select id="filterSent" onchange="applyFilters()">
<option value="all">Все отправки</option>
<option value="sent">Отправлено</option>
<option value="not_sent">Не отправлено</option>
</select>
<button onclick="addRow()">➕ Добавить строку</button>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>№</th>
<th>Имя</th>
<th>Телефон</th>
<th>Адрес</th>
<th>Товары</th>
<th>Сумма</th>
<th>Оплата</th>
<th>Сервис</th>
<th>Отправка</th>
<th>Сброс</th>
<th>Полный сброс</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<div class="status-bar">
<div class="status-item">
<span class="status-dot" id="statusDot"></span>
<span id="statusText">Готов</span>
</div>
<div class="status-item">
<span id="unsavedCount">Все изменения сохранены</span>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyAq7NnxP_58TGTdDyyZ3eTcWfECoyGvxC0",
authDomain: "mylitta-orders.firebaseapp.com",
projectId: "mylitta-orders",
storageBucket: "mylitta-orders.firebasestorage.app",
messagingSenderId: "882881706964",
appId: "1:882881706964:web:65b58522679ad561d17441"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let counter = 1;
let isUpdatingFromFirebase = false;
let unsavedChanges = new Set(); // Отслеживаем несохраненные поля
let isSaving = false; // Флаг процесса сохранения

/* Глобальные функции */
window.addRow = addRow;
window.applyFilters = applyFilters;
window.resetPurchases = resetPurchases;
window.resetFullRow = resetFullRow;
window.updateRowAppearance = updateRowAppearance;

/* Уведомление о сохранении */
function showSaveNotification(message = "Сохранено ✓", isSavingMsg = false) {
const notification = document.getElementById('saveNotification');
notification.textContent = message;
notification.classList.toggle('saving', isSavingMsg);
notification.classList.add('show');
setTimeout(() => {
notification.classList.remove('show');
}, isSavingMsg ? 1000 : 2000);
}

/* Обновление статус-бара */
function updateStatusBar() {
const statusText = document.getElementById('statusText');
const unsavedCountElem = document.getElementById('unsavedCount');
const statusDot = document.getElementById('statusDot');
  
if (isSaving) {
statusText.textContent = "Сохранение...";
statusDot.style.background = "#2196F3";
} else if (unsavedChanges.size > 0) {
statusText.textContent = "Есть несохраненные изменения";
statusDot.style.background = "#ff9800";
unsavedCountElem.textContent = `Не сохранено: ${unsavedChanges.size} полей`;
} else {
statusText.textContent = "Все изменения сохранены";
statusDot.style.background = "#4CAF50";
unsavedCountElem.textContent = "Все изменения сохранены";
}
}

/* Сохранение данных в Firebase */
async function saveDataToFirebase() {
if (isUpdatingFromFirebase || isSaving) return;
  
isSaving = true;
updateStatusBar();
showSaveNotification("Сохранение...", true);

try {
const rows = [];
document.querySelectorAll("#tableBody tr").forEach(row => {
const cells = row.querySelectorAll("input, textarea, select");
const rowData = [];
cells.forEach(c => rowData.push(c.value));
rows.push(rowData);
});

await set(ref(db, "orders"), rows);
  
// Убираем пометки о несохраненных изменениях
unsavedChanges.clear();
document.querySelectorAll('.changed').forEach(el => {
el.classList.remove('changed');
});
  
showSaveNotification("Сохранено ✓");
} catch (error) {
console.error("Ошибка сохранения:", error);
showSaveNotification("Ошибка сохранения!", true);
// Сохраняем в localStorage как резервную копию
localStorage.setItem('mylitta_backup', JSON.stringify(rows));
localStorage.setItem('mylitta_backup_time', new Date().toISOString());
} finally {
isSaving = false;
updateStatusBar();
}
}

/* Отметить поле как измененное */
function markAsChanged(field) {
const fieldId = `${field.dataset.row}-${field.className || field.tagName}`;
unsavedChanges.add(fieldId);
field.classList.add('changed');
updateStatusBar();
  
// Автосохранение через 5 секунд на всякий случай
clearTimeout(window.autoSaveTimer);
window.autoSaveTimer = setTimeout(() => {
if (unsavedChanges.size > 0) {
saveDataToFirebase();
}
}, 5000);
}

/* Загрузка данных */
function loadDataFromFirebase(rows) {
isUpdatingFromFirebase = true;
const table = document.getElementById("tableBody");
table.innerHTML = "";
counter = 1;

if (rows && rows.length > 0) {
rows.forEach(r => addRow(r));
} else {
const backup = localStorage.getItem('mylitta_backup');
if (backup) {
try {
const backupData = JSON.parse(backup);
backupData.forEach(values => addRow(values));
} catch (e) {
addRow();
}
} else {
addRow();
}
}

isUpdatingFromFirebase = false;
}

/* Добавление строки */
function addRow(savedData = null) {
const table = document.getElementById("tableBody");
const row = document.createElement("tr");
const rowId = Date.now() + Math.random();

row.innerHTML = `
<td>${counter}</td>
<td><input class="cell-name" placeholder="Имя клиента" data-row="${rowId}"></td>
<td><input class="cell-phone" placeholder="+375..." data-row="${rowId}"></td>
<td><input class="cell-address" placeholder="Адрес" data-row="${rowId}"></td>
<td><textarea class="cell-items" placeholder="Товар 1 100\nТовар 2 50" data-row="${rowId}"></textarea></td>
<td><input class="cell-sum" readonly value="0" data-row="${rowId}"></td>

<td>
<select class="cell-payment" data-row="${rowId}">
<option value="no">Не оплачено</option>
<option value="yes">Оплачено</option>
</select>
</td>

<td>
<select class="cell-service" data-row="${rowId}">
<option>Белпочта</option>
<option>ЕвроПочта</option>
<option>Самовывоз</option>
</select>
</td>

<td>
<select class="cell-sent" data-row="${rowId}">
<option value="no">Не отправлено</option>
<option value="yes">Отправлено</option>
</select>
</td>

<td><button onclick="resetPurchases(this)">Сбросить товары</button></td>
<td><button onclick="resetFullRow(this)">Полный сброс</button></td>
`;

table.appendChild(row);

/* ФИКС: Обработчик для поля "Товары" */
const items = row.querySelector(".cell-items");
const sum = row.querySelector(".cell-sum");

// Функция расчета суммы
function calculateSum() {
let total = 0;
const lines = items.value.split("\n");
lines.forEach(line => {
const trimmed = line.trim();
if (trimmed) {
const parts = trimmed.split(/\s+/);
const last = parseFloat(parts[parts.length - 1]);
if (!isNaN(last)) {
total += last;
}
}
});
sum.value = total.toFixed(2);
}

// Расчет суммы при изменении
items.addEventListener('input', calculateSum);

// Сохранение при выходе из поля
items.addEventListener('blur', function() {
markAsChanged(this);
saveDataToFirebase();
});

/* Обработчики для всех полей ввода */
row.querySelectorAll("input, textarea, select").forEach(el => {
// Пропускаем поле "Сумма" (оно readonly)
if (el.classList.contains('cell-sum')) return;

// Для селектов - сохранение при изменении
if (el.tagName === 'SELECT') {
el.addEventListener('change', function() {
if (this.classList.contains('cell-payment')) {
updateRowAppearance(this);
}
markAsChanged(this);
saveDataToFirebase();
});
}

// Для текстовых полей - сохранение при выходе
if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
el.addEventListener('blur', function() {
markAsChanged(this);
saveDataToFirebase();
});
}
});

// Автофокус при добавлении новой строки
if (!savedData) {
setTimeout(() => {
const nameInput = row.querySelector(".cell-name");
if (nameInput) {
nameInput.focus();
nameInput.select();
}
}, 50);
}

// Заполнение сохраненными данными
if (savedData) {
const inputs = row.querySelectorAll("input, textarea, select");
savedData.forEach((v, i) => {
if (inputs[i]) {
inputs[i].value = v;
if (inputs[i].classList.contains('cell-payment')) {
updateRowAppearance(inputs[i]);
}
if (inputs[i].classList.contains('cell-items')) {
calculateSum();
}
}
});
}

counter++;
}

function updateRowAppearance(select) {
const row = select.closest("tr");
if (select.value === "yes") {
row.classList.add("paid-row");
} else {
row.classList.remove("paid-row");
}
}

function resetPurchases(btn) {
const row = btn.closest("tr");
const items = row.querySelector(".cell-items");
const sum = row.querySelector(".cell-sum");
items.value = "";
sum.value = "0";
markAsChanged(items);
saveDataToFirebase();
}

function resetFullRow(btn) {
const row = btn.closest("tr");
row.querySelectorAll("input, textarea, select").forEach(el => {
if (el.classList.contains("cell-sum")) {
el.value = "0";
} else if (el.classList.contains("cell-payment")) {
el.value = "no";
updateRowAppearance(el);
} else if (el.classList.contains("cell-sent")) {
el.value = "no";
} else if (el.tagName === 'SELECT') {
el.value = el.querySelector('option').value;
} else if (el.tagName !== 'BUTTON') {
el.value = "";
}
if (!el.classList.contains('cell-sum')) {
markAsChanged(el);
}
});
row.classList.remove("paid-row");
saveDataToFirebase();
applyFilters();
}

function applyFilters() {
const search = document.getElementById("searchInput").value.toLowerCase();
const pay = document.getElementById("filterPayment").value;
const sent = document.getElementById("filterSent").value;

document.querySelectorAll("#tableBody tr").forEach(row => {
let visible = true;
const name = row.querySelector(".cell-name")?.value.toLowerCase() || "";
const payment = row.querySelector(".cell-payment")?.value || "no";
const sentVal = row.querySelector(".cell-sent")?.value || "no";

if (search && !name.includes(search)) visible = false;
if (pay === "paid" && payment !== "yes") visible = false;
if (pay === "unpaid" && payment !== "no") visible = false;
if (sent === "sent" && sentVal !== "yes") visible = false;
if (sent === "not_sent" && sentVal !== "no") visible = false;

row.style.display = visible ? "" : "none";
});
}

/* Инициализация при загрузке */
document.addEventListener('DOMContentLoaded', () => {
// Обновление статуса сети
function updateOnlineStatus() {
const statusDot = document.getElementById('statusDot');
if (navigator.onLine) {
statusDot.style.background = "#4CAF50";
} else {
statusDot.style.background = "#ff9800";
setTimeout(() => {
if (unsavedChanges.size > 0) {
showSaveNotification("Нет соединения. Изменения сохранены локально.", true);
}
}, 1000);
}
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

// Загружаем начальные данные
setTimeout(() => {
if (document.querySelectorAll("#tableBody tr").length === 0) {
addRow();
}
}, 200);
});

/* Автообновление из Firebase */
onValue(ref(db, "orders"), snap => {
const rows = snap.val();
if (rows && !isSaving && unsavedChanges.size === 0) {
loadDataFromFirebase(rows);
}
});

/* Сохранение при закрытии страницы */
window.addEventListener('beforeunload', function(e) {
if (unsavedChanges.size > 0) {
e.preventDefault();
e.returnValue = 'У вас есть несохраненные изменения. Вы уверены, что хотите уйти?';
saveDataToFirebase();
}
});

/* Периодическое сохранение (только если есть изменения) */
setInterval(() => {
if (unsavedChanges.size > 0 && !isSaving) {
saveDataToFirebase();
}
}, 30000);

</script>

</body>
</html>
